name: Simple ARM64 Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3

    - name: Build with Direct GraalVM Download
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v $(pwd):/workspace \
          -w /workspace \
          arm64v8/ubuntu:22.04 \
          /bin/bash -c "
            # 安装基础依赖
            apt update
            apt install -y wget git maven build-essential
            
            # 直接下载 GraalVM 25.0.1 for ARM64
            cd /opt
            wget https://github.com/graalvm/graalvm-ce-builds/releases/download/jdk-25.0.1/graalvm-community-jdk-25.0.1_linux-aarch64_bin.tar.gz
            sudo tar -xzf graalvm-community-jdk-25.0.1_linux-aarch64_bin.tar.gz /opt/
            export JAVA_HOME=/opt/graalvm-community-jdk-25.0.1
            export PATH=\$JAVA_HOME/bin:\$PATH
            
            sudo chmod 755 graalvm-community-jdk-25.0.1 -R
            cd /workspace
            git clone https://github.com/apache/maven-mvnd.git
            mvn clean verify -Pnative
          "

    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: mvnd-arm64
        path: client/target/mvnd