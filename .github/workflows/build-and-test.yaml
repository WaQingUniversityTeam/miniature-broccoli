name: Simple ARM64 Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3

    - name: Build with Proper Environment
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v $(pwd):/workspace \
          -w /workspace \
          arm64v8/ubuntu:22.04 \
          /bin/bash -c "
            # 安装基础依赖（去掉sudo，容器内是root）
            apt update
            apt install -y wget git
            
            # 下载并安装 GraalVM
            cd /opt
            wget https://github.com/graalvm/graalvm-ce-builds/releases/download/jdk-25.0.1/graalvm-community-jdk-25.0.1_linux-aarch64_bin.tar.gz
            tar -xzf graalvm-community-jdk-25.0.1_linux-aarch64_bin.tar.gz
            wget -q https://dlcdn.apache.org/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.tar.gz
            tar -xzf apache-maven-3.9.11-bin.tar.gz
            export MAVEN_HOME=/opt/apache-maven-3.9.11
            export PATH=\$MAVEN_HOME/bin:\$PATH
            
            # 正确设置环境变量
            export JAVA_HOME=/opt/graalvm-community-jdk-25.0.1_linux-aarch64_bin
            export PATH=$JAVA_HOME/bin:$PATH
            # 验证环境
            echo '=== Java Version ==='
            java -version
            echo '=== JAVA_HOME ==='
            echo \$JAVA_HOME
            
            # 构建 mvnd（注意仓库名是 maven-mvnd 不是 maven-mwnd）
            cd /workspace
            git clone https://github.com/apache/maven-mvnd.git && cd maven-mvnd
            mvn clean package -DskipTests -Pnative
          "

    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: mvnd-arm64
        path: client/target/mvnd